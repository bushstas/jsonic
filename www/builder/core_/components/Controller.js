__G.set((c=function(){
if(!this||this==window){
var makeUrl=function(url,options){var regExp,tmpUrl;for(var k in options){if(isString(options[k])||isNumber(options[k])){regExp=new RegExp('\$'+k);tmpUrl=url;url=url.replace(regExp,options[k]);if(tmpUrl!=url)delete options[k]}}return url};
var gotFromStore=function(actionName,options,initiator){if(actionName=='load'&&shouldStore.call(this)){var storeAs=getStoreAs.call(this,options);if(isString(storeAs)&&typeof StoreKeeper!='undefined'){var storedData=StoreKeeper.getActual(storeAs,__O.get(this.options,'storePeriod'));if(isArrayLike(storedData)){onActionComplete.call(this,actionName,true,initiator,storedData);return true}}}return false};
var isPrivate=function(initiator){return initiator&&this.privateSubscribers.has(initiator.getUniqueId())};
var onActionComplete=function(actionName,isFromStorage,initiator,data){this.activeRequests.removeItem(actionName);if(initiator&&!isPrivate.call(this,initiator))initiator=null;this.data=this.data||{};this.data[actionName]=data;var action=getAction.call(this,actionName);if(isObject(action)&&isFunction(action['callback'])){action['callback'].call(this,data)}if(action['autoset'])autoset.call(this,action['autoset'],data,initiator);this.dispatchEvent(actionName,data,initiator);if(!isFromStorage&&actionName=='load'&&shouldStore.call(this)){store.call(this,true,data)}};
var autoset=function(opts,data,initiator){var props={};if(isString(opts)){props[opts]=data}else if(isObject(opts)){for(var k in opts)props[opts[k]]=data[k]}if(initiator)initiator.set(props);else if(isArray(this.subscribers['load'])){for(var i=0;i<this.subscribers['load'].length;i++){this.subscribers['load'][i]['initiator'].set(props)}}};
var shouldStore=function(){var should=__O.get(this.options,'store');if(should===false)return false;return __O.has(this.options,'storeAs')};
var store=function(isAdding,data){if(typeof StoreKeeper=='undefined')return;var storeAs=getStoreAs.call(this,data);if(isAdding){StoreKeeper.set(storeAs,data)}else{StoreKeeper.remove(storeAs)}};
var getStoreAs=function(data){var storeAs=__O.get(this.options,'storeAs');if(isArrayLike(data)&&isString(storeAs)&&(/$[a-z_]/i).test(storeAs)){var parts=storeAs.split('$');storeAs=parts[0];for(var i=1;i<parts.length;i++){if(data[parts[i]])storeAs+=data[parts[i]];else storeAs+=parts[i]}}return storeAs};
var getPrimaryKey=function(){return __O.get(this.options,'key','id')};
var initActionRouteOptions=function(action){var value;this.currentRouteOptions={};var routeOptions={};for(var k in action['routeOptions']){value=Router.getPathPartAt(action['routeOptions'][k]);if(isString(value)){routeOptions[k]=value}}setCurrentRouteOptions.call(this,routeOptions,action);Router.subscribe(action['routeOptions'],this)};
var setCurrentRouteOptions=function(routeOptions,action){this.currentRouteOptions=routeOptions;if(!isObject(action['options'])){action['options']={}}for(var k in routeOptions){action['options'][k]=routeOptions[k]}};
var getAction=function(actionName){var actions=__O.get(this.initials,'actions');if(isObject(actions)){var action=actions[actionName];if(isObject(action)){if(!isString(action['name'])){if(isObject(action['routeOptions'])&&actionName=='load'){initActionRouteOptions.call(this,action)}action['name']=actionName}return action}}return null};
var getNewRequest=function(){var ajr=__G.get('AjaxRequest');return new ajr()};
var getRequest=function(action){return this.requests[action['name']]=this.requests[action['name']]||getNewRequest()};
var getOptions=function(options,action,initiator){if(!isObject(options))options={};if(isObject(action['options']))__O.merge(options,action['options']);if(isPrivate.call(this,initiator)){__O.merge(options,getPrivateOptions.call(this,initiator))}return options};
var getPrivateOptions=function(initiator){return this.privateOptions[initiator.getUniqueId()]};
var send=function(action,options,initiator){var url=makeUrl(action['url'],options);var req=getRequest.call(this,action);req.setCallback(onActionComplete.bind(this,action['name'],false,initiator));req.send(action['method'],options,url);this.activeRequests.push(action['name'])};
p=c.prototype;
p.initiate=function(){this.subscribers={};this.requests={};this.activeRequests=[];this.privateSubscribers=[];this.privateOptions={}};
p.addSubscriber=function(actionName,data,isPriv,options){this.subscribers[actionName]=this.subscribers[actionName]||[];this.subscribers[actionName].push(data);if(isPriv){var uid=data['initiator'].getUniqueId();this.privateSubscribers.push(uid);if(options)this.privateOptions[uid]=options}};
p.removeSubscriber=function(initiator){this.privateSubscribers.removeItem(initiator.getUniqueId());var done=false;for(var actionName in this.subscribers){for(var i=0;i<this.subscribers[actionName].length;i++){if(this.subscribers[actionName][i]['initiator']==initiator){this.subscribers[actionName].splice(i,1);break}}}};
p.dispatchEvent=function(actionName,data,initiator){var dataToDispatch=data;if(__O.has(this.options,'clone',true))dataToDispatch=__O.clone(data);var s=this.subscribers[actionName],i,p;if(isArray(s)){for(i=0;i<s.length;i++){p=(!initiator&&!isPrivate.call(this,s[i]['initiator']))||initiator==s[i]['initiator'];if(p&&isFunction(s[i]['callback'])){s[i]['callback'].call(s[i]['initiator'],dataToDispatch,this)}}}};
p.instanceOf=function(classFunc){if(isString(classFunc))classFunc=__G.get(classFunc);return this instanceof classFunc||(this.inheritedSuperClasses&&this.inheritedSuperClasses.indexOf(classFunc)>-1)};
p.getData=function(actionName){return!!action&&!!this.data&&isObject(this.data)?this.data[action]:this.data};
p.getItemById=function(id){var primaryKey=getPrimaryKey.call(this);var data=this.data['load'];if(isArray(data)){for(var i=0;i<data.length;i++){if(__O.has(data[i],primaryKey,id))return data[i]}}return null};
p.getItem=function(nameOrIndex,actionName){actionName=actionName||'load';return isArrayLike(this.data[actionName])?this.data[actionName][nameOrIndex]:null};
p.doAction=function(initiator,actionName,options){if(this.activeRequests.has(actionName))return;var action=getAction.call(this,actionName);if(isObject(action)&&!gotFromStore.call(this,actionName,options,initiator)){options=getOptions.call(this,options,action,initiator);send.call(this,action,options,initiator)}};
p.handleRouteOptionsChange=function(routeOptions){if(!__O.equals(routeOptions,this.currentRouteOptions)){setCurrentRouteOptions.call(this,routeOptions,getAction.call(this,'load'));this.doAction(null,'load')}};
return c;
}
})(),'Controller');